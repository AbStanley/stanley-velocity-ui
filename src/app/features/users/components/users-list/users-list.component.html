<div class="list-container">
    <!-- Toolbar / Controls -->
    <!-- Toolbar -->
    <app-users-toolbar [searchQuery]="usersService.searchQuery()" [currentCriteria]="usersService.currentCriteria()"
        [totalUsers]="usersService.users().length" (search)="usersService.setSearchQuery($event)"
        (groupingChange)="setCriteria($event)" (clearSearch)="usersService.setSearchQuery('')">
    </app-users-toolbar>

    <div class="list-header">
        <div class="col-user">User</div>
        <div class="col-contact">Contact</div>
        <div class="col-details">Details</div>
    </div>

    <!-- Loading State (Skeleton) -->
    @if (usersService.isLoading() && usersService.users().length === 0) {
    <div class="loading-state">
        @for (i of [1,2,3,4,5,6]; track i) {
        <div class="global-skeleton-card">
            <div class="skeleton-avatar"></div>
            <div class="skeleton-info">
                <div class="skeleton-line short"></div>
                <div class="skeleton-line long"></div>
            </div>
        </div>
        }
    </div>
    }

    <!-- Error State -->
    @if (usersService.error(); as err) {
    @if (usersService.users().length === 0) {
    <div class="global-error-state">
        <div class="error-icon">!</div>
        <p>{{ err }}</p>
        <button class="retry-btn" (click)="usersService.fetchUsers()">Retry</button>
    </div>
    }
    }

    <!-- Content -->
    <div class="content post-loading" [class.hidden]="usersService.isLoading() && usersService.users().length === 0">

        <!-- Virtual Scroll Container -->
        <cdk-virtual-scroll-viewport class="scroll-container custom-scrollbar" appScrollNearBottom
            (nearBottom)="onScrollNearBottom()">

            <div *cdkVirtualFor="let item of flattenedUsers(); trackBy: trackByFn; let i = index" class="virtual-item"
                [style.height.px]="item.type === 'header' ? UI.HEADER_HEIGHT : (isMobile() ? UI.ITEM_HEIGHT_MOBILE : UI.ITEM_HEIGHT_DESKTOP)">

                @if (isHeader(item)) {
                <div class="group-header-item">
                    <div class="header-content">
                        <span class="header-title">{{ item.label }}</span>
                        <span class="global-badge">{{ item.count }}</span>
                    </div>
                </div>
                }

                @if (isUser(item)) {
                <div class="user-card-wrapper">
                    <app-user-card [user]="item.data" [expanded]="expandedUserIds().has(item.data.login.uuid)"
                        (toggle)="toggleUser(item.data.login.uuid)">
                    </app-user-card>
                </div>
                }
            </div>

            @if (usersService.isLoading() && usersService.users().length > 0) {
            <div class="global-loading-more">
                <div class="spinner-small"></div>
                <span>Loading more users...</span>
            </div>
            }

            @if (usersService.error() && usersService.users().length > 0) {
            <div class="global-loading-more error">
                <span>{{ usersService.error() }}</span>
                <button class="retry-btn-small" (click)="usersService.loadMore()">Retry</button>
            </div>
            }
        </cdk-virtual-scroll-viewport>

    </div>
</div>