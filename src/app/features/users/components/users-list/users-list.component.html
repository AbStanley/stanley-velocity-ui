<div class="list-container">
    <!-- Toolbar / Controls -->
    <div class="toolbar">
        <div class="grouping-controls">
            <div class="search-box">
                <input type="text" placeholder="Search users..." [value]="usersService.searchQuery()"
                    (input)="onSearch($event)">
                @if (usersService.searchQuery()) {
                <button class="clear-search" (click)="usersService.setSearchQuery('')">x</button>
                }
            </div>

            <span class="label">Group by</span>
            <div class="segment-control">
                <button [class.active]="usersService.currentCriteria() === 'all'"
                    (click)="setCriteria('all')">All</button>
                <button [class.active]="usersService.currentCriteria() === 'alphabetical'"
                    (click)="setCriteria('alphabetical')">Alphabetical</button>
                <button [class.active]="usersService.currentCriteria() === 'age'"
                    (click)="setCriteria('age')">Age</button>
                <button [class.active]="usersService.currentCriteria() === 'nationality'"
                    (click)="setCriteria('nationality')">Nationality</button>
            </div>
        </div>

        <div class="stats">
            @if (usersService.users().length; as total) {
            <span class="user-count">{{ total }} Users</span>
            }
        </div>
    </div>

    <div class="list-header">
        <div class="col-user">User</div>
        <div class="col-contact">Contact</div>
        <div class="col-details">Details</div>
    </div>

    <!-- Loading State (Skeleton) -->
    @if (usersService.isLoading() && usersService.users().length === 0) {
    <div class="loading-state">
        @for (i of [1,2,3,4,5,6]; track i) {
        <div class="skeleton-card">
            <div class="skeleton-avatar"></div>
            <div class="skeleton-info">
                <div class="skeleton-line short"></div>
                <div class="skeleton-line long"></div>
            </div>
        </div>
        }
    </div>
    }

    <!-- Error State -->
    @if (usersService.error(); as err) {
    <div class="error-state">
        <div class="error-icon">!</div>
        <p>{{ err }}</p>
        <button class="retry-btn" (click)="usersService.fetchUsers()">Retry</button>
    </div>
    }

    <!-- Content -->
    <div class="content post-loading" [class.hidden]="usersService.isLoading() && usersService.users().length === 0">

        <!-- Virtual Scroll Container -->
        <cdk-virtual-scroll-viewport class="scroll-container">

            <div *cdkVirtualFor="let item of flattenedUsers(); trackBy: trackByFn" class="virtual-item"
                [style.height.px]="item.type === 'header' ? 50 : (isMobile() ? 180 : 120)">
                @switch (item.type) {
                @case ('header') {
                <div class="group-header-item">
                    <div class="header-content">
                        <span class="header-title">{{ $any(item).label }}</span>
                        <span class="header-badge">{{ $any(item).count }}</span>
                    </div>
                </div>
                }
                @case ('user') {
                <div class="user-card-wrapper">
                    <app-user-card [user]="$any(item).data"
                        [expanded]="expandedUserIds().has($any(item).data.login.uuid)"
                        (toggle)="toggleUser($any(item).data.login.uuid)">
                    </app-user-card>
                </div>
                }
                }
            </div>

            @if (usersService.isLoading() && usersService.users().length > 0) {
            <div class="loading-more">
                <div class="spinner-small"></div>
                <span>Loading more users...</span>
            </div>
            }
        </cdk-virtual-scroll-viewport>

    </div>
</div>