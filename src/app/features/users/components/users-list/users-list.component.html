<div class="list-container">
    <!-- Toolbar / Controls -->
    <div class="toolbar">
        <div class="grouping-controls">
            <span class="label">Group by:</span>
            <div class="btn-group">
                <button [class.active]="usersService.currentCriteria() === 'none'"
                    (click)="setCriteria('none')">None</button>
                <button [class.active]="usersService.currentCriteria() === 'alphabetical'"
                    (click)="setCriteria('alphabetical')">Alphabetical</button>
                <button [class.active]="usersService.currentCriteria() === 'age'"
                    (click)="setCriteria('age')">Age</button>
                <button [class.active]="usersService.currentCriteria() === 'nationality'"
                    (click)="setCriteria('nationality')">Nationality</button>
            </div>
        </div>

        <div class="stats">
            @if (usersService.users().length; as total) {
            <span>Total: {{ total }} users</span>
            }
        </div>
    </div>

    <!-- Loading State (Initial) -->
    @if (usersService.isLoading() && usersService.users().length === 0) {
    <div class="loading-state">
        <div class="spinner"></div>
        <p>Loading Users...</p>
    </div>
    }

    <!-- Error State -->
    @if (usersService.error(); as err) {
    <div class="error-state">
        <p>{{ err }}</p>
        <button (click)="usersService.fetchUsers()">Retry</button>
    </div>
    }

    <!-- Content -->
    <div class="content post-loading" [class.hidden]="usersService.isLoading() && usersService.users().length === 0">

        <!-- Single Virtual Scroll for EVERYTHING (Flat & Grouped) -->
        <cdk-virtual-scroll-viewport itemSize="80" class="viewport" (scrolledIndexChange)="onScroll()">

            <div *cdkVirtualFor="let item of flattenedUsers(); trackBy: trackByFn" class="virtual-item">

                @switch (item.type) {
                @case ('header') {
                <div class="group-header-item">
                    <span class="header-title">{{ $any(item).label }}</span>
                    <span class="header-count">({{ $any(item).count }})</span>
                </div>
                }
                @case ('user') {
                <app-user-card [user]="$any(item).data" [expanded]="expandedUserIds().has($any(item).data.login.uuid)"
                    (toggle)="toggleUser($any(item).data.login.uuid)">
                </app-user-card>
                }
                }

            </div>
        </cdk-virtual-scroll-viewport>

        @if (usersService.isLoading() && usersService.users().length > 0) {
        <div class="loading-more">
            <div class="spinner-small"></div>
            <span>Loading more...</span>
        </div>
        }

    </div>
</div>