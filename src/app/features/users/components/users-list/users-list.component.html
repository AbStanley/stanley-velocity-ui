<div class="list-container">
    <!-- Toolbar / Controls -->
    <div class="toolbar">
        <div class="grouping-controls">
            <span class="label">Group by:</span>
            <div class="btn-group">
                <button [class.active]="usersService.currentCriteria() === 'none'"
                    (click)="setCriteria('none')">None</button>
                <button [class.active]="usersService.currentCriteria() === 'alphabetical'"
                    (click)="setCriteria('alphabetical')">Alphabetical</button>
                <button [class.active]="usersService.currentCriteria() === 'age'"
                    (click)="setCriteria('age')">Age</button>
                <button [class.active]="usersService.currentCriteria() === 'nationality'"
                    (click)="setCriteria('nationality')">Nationality</button>
            </div>
        </div>

        <div class="stats">
            @if (usersService.users().length; as total) {
            <span>Total: {{ total }} users</span>
            }
        </div>
    </div>

    <!-- Loading State -->
    @if (usersService.isLoading()) {
    <div class="loading-state">
        <div class="spinner"></div>
        <p>Loading Users...</p>
    </div>
    }

    <!-- Error State -->
    @if (usersService.error(); as err) {
    <div class="error-state">
        <p>{{ err }}</p>
        <button (click)="usersService.fetchUsers()">Retry</button>
    </div>
    }

    <!-- Content -->
    @if (!usersService.isLoading()) {
    <div class="content post-loading">

        <!-- Single Virtual Scroll for EVERYTHING (Flat & Grouped) -->
        <cdk-virtual-scroll-viewport itemSize="80" class="viewport">
            <!-- 
                    Using *cdkVirtualFor with our flattened list.
                    We switch on 'item.type' to decide what to render.
                -->
            <div *cdkVirtualFor="let item of flattenedUsers(); trackBy: trackByFn" class="virtual-item">

                @switch (item.type) {
                @case ('header') {
                <!-- Header Item -->
                <div class="group-header-item">
                    <!-- We need to cast item to the specific header type to access properties safely in template? 
                                     Angular templates are loose, but let's be aware. 
                                     'item' is UserListItem. 
                                 -->
                    <span class="header-title">{{ $any(item).label }}</span>
                    <span class="header-count">({{ $any(item).count }})</span>
                </div>
                }
                @case ('user') {
                <!-- User Item -->
                <app-user-card [user]="$any(item).data" [expanded]="expandedUserIds().has($any(item).data.login.uuid)"
                    (toggle)="toggleUser($any(item).data.login.uuid)">
                </app-user-card>
                }
                }

            </div>
        </cdk-virtual-scroll-viewport>

    </div>
    }
</div>